<?xml version="1.0" encoding="UTF-8"?>
<prov:document xmlns:prov="http://www.w3.org/ns/prov#"
               xmlns:dcterms="http://purl.org/dc/terms/"
               xmlns:xsd="http://www.w3.org/2001/XMLSchema#"
               xmlns:ex="http://example.org/">

    <!-- Entidad: Tabla l1booksstage2 -->
    <prov:entity prov:id="ex:l1booksstage2">
        <prov:label>Tabla l1booksstage2</prov:label>
        <prov:type>prov:Collection</prov:type>
        <dcterms:description>
            Tabla intermedia derivada de l1booksstage1 tras aplicar un proceso de
            deduplicación y filtrado de registros sin información relevante.
            Representa una versión depurada y consolidada del dataset Amazon Books,
            garantizando unicidad por título, autores y editorial.
        </dcterms:description>

        <prov:wasDerivedFrom prov:entity="ex:l1booksstage1"/>

        <!-- Columnas (representadas como miembros) -->
        <prov:hadMember prov:entity="ex:title"/>
        <prov:hadMember prov:entity="ex:description"/>
        <prov:hadMember prov:entity="ex:authors"/>
        <prov:hadMember prov:entity="ex:image"/>
        <prov:hadMember prov:entity="ex:previewlink"/>
        <prov:hadMember prov:entity="ex:publisher"/>
        <prov:hadMember prov:entity="ex:publisheddate"/>
        <prov:hadMember prov:entity="ex:infolink"/>
        <prov:hadMember prov:entity="ex:categories"/>
        <prov:hadMember prov:entity="ex:isbn"/>
    </prov:entity>

    <!-- Definición de columnas como entidades -->
    <prov:entity prov:id="ex:title">
        <prov:label>title</prov:label>
        <prov:type>xsd:string</prov:type>
        <dcterms:description>
            Se conserva como identificador principal del libro.
            Utilizado como parte de la clave natural de deduplicación
            (LOWER(title)). Se mantiene para el matching posterior con l2books.
        </dcterms:description>
    </prov:entity>

    <prov:entity prov:id="ex:description">
        <prov:label>description</prov:label>
        <prov:type>xsd:string</prov:type>
        <dcterms:description>
            Conservado solo si existe contenido no nulo.
            Permite enriquecer la información bibliográfica y justificar
            la permanencia del registro en esta tabla.
        </dcterms:description>
    </prov:entity>

    <prov:entity prov:id="ex:authors">
        <prov:label>authors</prov:label>
        <prov:type>xsd:string</prov:type>
        <dcterms:description>
            Incluido como parte de la clave de deduplicación (LOWER(authors::text)).
            Se mantiene porque aporta contexto semántico y relevancia en la integración.
        </dcterms:description>
    </prov:entity>

    <prov:entity prov:id="ex:image">
        <prov:label>image</prov:label>
        <prov:type>xsd:anyURI</prov:type>
        <dcterms:description>
            Se conserva si tiene valor. Permite mantener la representación visual
            del libro en las etapas de integración o visualización.
        </dcterms:description>
    </prov:entity>

    <prov:entity prov:id="ex:previewlink">
        <prov:label>previewlink</prov:label>
        <prov:type>xsd:anyURI</prov:type>
        <dcterms:description>
            Conservado si no es nulo. Es una referencia externa al recurso original
            en Google Books o Amazon, útil para validación cruzada.
        </dcterms:description>
    </prov:entity>

    <prov:entity prov:id="ex:publisher">
        <prov:label>publisher</prov:label>
        <prov:type>xsd:string</prov:type>
        <dcterms:description>
            Parte de la clave de deduplicación (LOWER(publisher)).
            Se mantiene para identificar ediciones y consolidar editoriales equivalentes.
        </dcterms:description>
    </prov:entity>

    <prov:entity prov:id="ex:publisheddate">
        <prov:label>publisheddate</prov:label>
        <prov:type>xsd:gYear</prov:type>
        <dcterms:description>
            Se conserva el año más reciente al aplicar ORDER BY DESC
            durante la deduplicación, garantizando la vigencia del registro.
        </dcterms:description>
    </prov:entity>

    <prov:entity prov:id="ex:infolink">
        <prov:label>infolink</prov:label>
        <prov:type>xsd:anyURI</prov:type>
        <dcterms:description>
            Conservado si tiene valor no nulo; referencia informativa complementaria
            al registro bibliográfico.
        </dcterms:description>
    </prov:entity>

    <prov:entity prov:id="ex:categories">
        <prov:label>categories</prov:label>
        <prov:type>xsd:string</prov:type>
        <dcterms:description>
            Conservado si contiene géneros o categorías válidas.
            Puede emplearse para análisis de similitud o clasificación temática.
        </dcterms:description>
    </prov:entity>

    <prov:entity prov:id="ex:isbn">
        <prov:label>isbn</prov:label>
        <prov:type>xsd:string</prov:type>
        <dcterms:description>
            Campo agregado durante la vinculación con l1ratingsstage1.
            Permite asociar de forma única libros y reseñas mediante coincidencia exacta de título.
        </dcterms:description>
    </prov:entity>

    <!-- Actividades -->
    <prov:activity prov:id="ex:deduplicate_l1booksstage2"
                   prov:startTime="2025-11-01T10:00:00"
                   prov:endTime="2025-11-01T10:30:00">
        <prov:label>Eliminación de duplicados y registros vacíos en l1booksstage1</prov:label>
        <dcterms:description>
            Proceso SQL ejecutado en PostgreSQL para crear la tabla l1booksstage2 a partir de l1booksstage1.
            Se aplicó SELECT DISTINCT ON combinando los campos normalizados title, authors y publisher,
            seleccionando la versión más reciente (publisheddate DESC). Luego se eliminaron registros
            que carecían completamente de información descriptiva, asegurando un conjunto limpio y único.
        </dcterms:description>
        <prov:used prov:entity="ex:l1booksstage1"/>
    </prov:activity>

    <prov:activity prov:id="ex:enrich_l1booksstage2_with_isbn"
                   prov:startTime="2025-11-06T13:02:00"
                   prov:endTime="2025-11-06T13:17:00">
        <prov:label>Enriquecimiento de l1booksstage2 con identificadores ISBN</prov:label>
        <dcterms:description>
            Proceso SQL ejecutado en PostgreSQL que agrega la columna isbn a l1booksstage2.
            Se realiza un cruce con l1ratingsstage1, asignando el ISBN solo a títulos
            presentes una única vez en ambas tablas, para evitar ambigüedades.
        </dcterms:description>
        <prov:used prov:entity="ex:l1ratingsstage1"/>
        <prov:used prov:entity="ex:l1booksstage2"/>
    </prov:activity>

    <!-- Agentes -->
    <prov:agent prov:id="ex:integra2">
        <prov:label>Grupo Integra2</prov:label>
        <prov:type>prov:Organization</prov:type>
        <prov:role>Ejecutó y supervisó la deduplicación y limpieza.</prov:role>
    </prov:agent>

    <prov:agent prov:id="ex:postgresql_db">
        <prov:label>PostgreSQL Engine</prov:label>
        <prov:type>prov:SoftwareAgent</prov:type>
        <prov:role>Ejecutó las consultas SQL de eliminación de duplicados y registros nulos.</prov:role>
    </prov:agent>

    <!-- Relaciones -->
    <prov:wasGeneratedBy prov:entity="ex:l1booksstage2"
                         prov:activity="ex:deduplicate_l1booksstage2"/>
    <prov:wasAssociatedWith prov:activity="ex:deduplicate_l1booksstage2"
                            prov:agent="ex:integra2"/>
    <prov:wasAssociatedWith prov:activity="ex:deduplicate_l1booksstage2"
                            prov:agent="ex:postgresql_db"/>
</prov:document>
